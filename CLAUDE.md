# CLAUDE.md

このファイルは、このリポジトリでClaude Code (claude.ai/code)が作業する際のガイダンスを提供します。

## プロジェクト概要

Java 21、Spring Boot 3.5.0、Gradleを使用したマルチモジュールアーキテクチャで構築された鉄道シミュレーションゲームプロジェクトです。モノリシック構造からマイクロサービスへの段階的な進化を計画した分散処理アプローチを採用しています。

## コアアーキテクチャ

### モジュール構造
- **apps/game-server/**: メインのゲームサーバーとして機能するSpring Bootアプリケーション
- **packages/shared-models/**: モジュール間で共有される共通データモデル
- **proto/**: サービス間通信用のProtocol Buffers定義
- **docs/**: 包括的なプロジェクトドキュメントとガイドライン

### 主要技術
- **バックエンド**: Java 21、Spring Boot 3.5.0、gRPC、Protocol Buffers
- **ビルドシステム**: Gradleマルチモジュール構成
- **通信**: サービス間通信にgRPCを使用
- **データモデル**: 電車、駅、住民、路線、イベントの共有モデル

## よく使用するコマンド

### ビルドコマンド
```bash
# プロジェクト全体のビルド
./gradlew build

# ゲームサーバーの個別ビルド
./gradlew buildGameServer

# ビルド成果物のクリーンアップ
./gradlew clean

# テスト実行
./gradlew test

# ゲームサーバーの起動
./gradlew :apps:game-server:bootRun
```

### 開発コマンド
```bash
# 利用可能なタスクの表示
./gradlew tasks

# プロジェクト構造の表示
./gradlew projects

# Protocol Buffers生成
./gradlew generateProto
```

## プロジェクト構造

### 現在の実装（フェーズ1）
- **モノリシックコア**: 統合されたシミュレーションロジックを持つゲームサーバー
- **共有モデル**: 電車、駅、住民の共通データ構造
- **Protocol Buffers**: 将来のサービス通信用定義

### 計画的な進化
プロジェクトは3つのフェーズで進化する設計：
1. **フェーズ1**: マルチスレッディングによるモノリシック実装
2. **フェーズ2**: 読み取り専用サービス分離（経路探索、アナリティクス、マップレンダリング）
3. **フェーズ3**: リアルタイムサービス分離（ブロードキャスト、時刻表管理）

## 主要なドメインモデル

### 電車システム
- **Train**: 位置、速度、路線情報を持つ基本的な電車エンティティ
- **Station**: 鉄道駅エンティティ
- **Route**: 鉄道路線定義

### 住民システム
- **TravelPlan**: 発車地、目的地、出発時刻、優先路線を含むレコード
- **PersonalInfo**: 住民の個人情報
- **EconomicStatus**: 住民の経済状況

### イベントシステム
- **Event**: ゲームイベントと分散処理用のベースイベントクラス

## 開発ガイドライン

### コード構成
- `net.rushhourgame`以下の既存のパッケージ構造に従う
- 不変データには（TravelPlanのような）recordタイプを使用
- `packages/shared-models`モジュールで共有モデルを実装

### Protocol Buffers
- Protoファイルは`proto/`ディレクトリに配置
- 生成されたJavaクラスは`net.rushhourgame.proto`パッケージを使用
- 現在のproto定義には電車、経路探索、リアルタイム、アナリティクスが含まれる

### テスト
- テストにはJUnit Platformを使用
- テストクラスはSpring Bootテスト規約に従う
- `./gradlew test`でテストを実行

### ブランチ管理
- **mainブランチはprotectedであり、変更を加えるときは常に新しいbranchを切るようにする**
- ブランチ名は機能や修正内容がわかるように命名する（例：`feature/train-physics`、`fix/station-rendering`）
- 作業完了後はプルリクエストを作成してmainブランチにマージする

### コミットメッセージとPRについて
- **コミットメッセージは日本語で記述**してください
- **プルリクエストのタイトルと説明も日本語で記述**してください
- コミットメッセージの形式: `feat: 新機能を追加` `fix: バグを修正` `docs: ドキュメントを更新`

## ドキュメント

`docs/`ディレクトリに包括的なドキュメントが用意されています：
- **project-guideline/**: プロジェクト構造と開発ガイドライン
- **development-plan.md**: 詳細な開発ロードマップと進捗追跡
- **distributed-processing-guideline.md**: 分散アーキテクチャの原則
- **protocol-guideline.md**: プロトコル定義と通信パターン

### ドキュメント更新ポリシー
- **実装によってdocsの内容と乖離が出た場合、docsを更新し、常にdocsが最新になるようにする**
- アーキテクチャの変更、新機能の追加、既存機能の修正時は対応するドキュメントも同時に更新する
- コードとドキュメントの整合性を保つことを最優先とする

## アーキテクチャの原則

### 分散処理
プロジェクトはスケーラビリティを考慮した分散処理アーキテクチャを採用：
- **アクターモデル**: 同時実行ゲームエンティティ管理
- **空間グリッド**: 効率的な衝突検出と空間クエリ
- **イベント駆動**: イベントソーシングによる状態管理
- **マイクロサービス**: モノリスからマイクロサービスへの段階的進化

### パフォーマンス目標
- **シミュレーション**: 30fpsのゲームシミュレーションティックレート
- **同時実行**: 100-5000の同時電車操作をサポート
- **スケーラビリティ**: 高負荷シナリオ向けの水平スケール機能