name: Progress Tracking
on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 9 * * *' # æ¯æ—¥9æ™‚

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦Gitçµ±è¨ˆç”¨
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Run Tests and Generate Coverage Report
        run: |
          ./gradlew clean test jacocoRootReport
          
      - name: Extract Test Metrics
        id: test-metrics
        run: |
          # ãƒ†ã‚¹ãƒˆçµæœã®é›†è¨ˆ
          TEST_RESULTS=$(find . -name "TEST-*.xml" -exec grep -o 'tests="[0-9]*"' {} \; | sed 's/tests="//' | sed 's/"//' | paste -sd+ - | bc)
          TEST_FAILURES=$(find . -name "TEST-*.xml" -exec grep -o 'failures="[0-9]*"' {} \; | sed 's/failures="//' | sed 's/"//' | paste -sd+ - | bc)
          TEST_ERRORS=$(find . -name "TEST-*.xml" -exec grep -o 'errors="[0-9]*"' {} \; | sed 's/errors="//' | sed 's/"//' | paste -sd+ - | bc)
          
          echo "TEST_TOTAL=${TEST_RESULTS:-0}" >> $GITHUB_OUTPUT
          echo "TEST_FAILURES=${TEST_FAILURES:-0}" >> $GITHUB_OUTPUT
          echo "TEST_ERRORS=${TEST_ERRORS:-0}" >> $GITHUB_OUTPUT
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã®æŠ½å‡º
          if [ -f "build/reports/jacoco/jacocoRootReport/jacocoRootReport.xml" ]; then
            COVERAGE=$(grep -o 'type="INSTRUCTION".*covered="[0-9]*".*missed="[0-9]*"' build/reports/jacoco/jacocoRootReport/jacocoRootReport.xml | head -1 | sed 's/.*covered="\([0-9]*\)".*missed="\([0-9]*\)".*/\1 \2/' | awk '{printf "%.1f", $1/($1+$2)*100}')
            echo "COVERAGE=${COVERAGE:-0}" >> $GITHUB_OUTPUT
          else
            echo "COVERAGE=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Extract Git Metrics
        id: git-metrics
        run: |
          # éå»1æ—¥ã®ã‚³ãƒŸãƒƒãƒˆæ•°
          COMMITS_TODAY=$(git log --since="1 day ago" --oneline | wc -l)
          echo "COMMITS_TODAY=${COMMITS_TODAY}" >> $GITHUB_OUTPUT
          
          # éå»1é€±é–“ã®å¤‰æ›´çµ±è¨ˆ
          LINES_ADDED=$(git log --since="1 week ago" --numstat --pretty=format:"" | awk '{added+=$1} END {print added+0}')
          LINES_DELETED=$(git log --since="1 week ago" --numstat --pretty=format:"" | awk '{deleted+=$2} END {print deleted+0}')
          FILES_CHANGED=$(git log --since="1 week ago" --name-only --pretty=format:"" | sort -u | wc -l)
          
          echo "LINES_ADDED=${LINES_ADDED}" >> $GITHUB_OUTPUT
          echo "LINES_DELETED=${LINES_DELETED}" >> $GITHUB_OUTPUT
          echo "FILES_CHANGED=${FILES_CHANGED}" >> $GITHUB_OUTPUT
          
          # ãƒ–ãƒ©ãƒ³ãƒæ•°
          BRANCH_COUNT=$(git branch -r | wc -l)
          echo "BRANCH_COUNT=${BRANCH_COUNT}" >> $GITHUB_OUTPUT
          
      - name: Calculate Build Status
        id: build-status
        run: |
          BUILD_STATUS="success"
          if [ ${{ steps.test-metrics.outputs.TEST_FAILURES }} -gt 0 ] || [ ${{ steps.test-metrics.outputs.TEST_ERRORS }} -gt 0 ]; then
            BUILD_STATUS="warning"
          fi
          
          echo "BUILD_STATUS=${BUILD_STATUS}" >> $GITHUB_OUTPUT
          
          # å“è³ªã‚¹ã‚³ã‚¢ã®è¨ˆç®— (0-100)
          COVERAGE_SCORE=$(echo "${{ steps.test-metrics.outputs.COVERAGE }}" | awk '{print int($1)}')
          TEST_SUCCESS_RATE=$(echo "${{ steps.test-metrics.outputs.TEST_TOTAL }} ${{ steps.test-metrics.outputs.TEST_FAILURES }} ${{ steps.test-metrics.outputs.TEST_ERRORS }}" | awk '{if($1>0) print int(($1-$2-$3)/$1*100); else print 100}')
          QUALITY_SCORE=$(echo "${COVERAGE_SCORE} ${TEST_SUCCESS_RATE}" | awk '{print int(($1*0.6 + $2*0.4))}')
          
          echo "QUALITY_SCORE=${QUALITY_SCORE}" >> $GITHUB_OUTPUT
          
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            build/reports/jacoco/jacocoRootReport/
            **/build/reports/jacoco/test/
            
      - name: Send Slack Notification
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ“Š Daily Progress Update - Rush Hour Game",
              "attachments": [{
                "color": "${{ steps.build-status.outputs.BUILD_STATUS == 'success' && 'good' || steps.build-status.outputs.BUILD_STATUS == 'warning' && 'warning' || 'danger' }}",
                "fields": [
                  {
                    "title": "ğŸ¯ å“è³ªã‚¹ã‚³ã‚¢",
                    "value": "${{ steps.build-status.outputs.QUALITY_SCORE }}/100",
                    "short": true
                  },
                  {
                    "title": "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸",
                    "value": "${{ steps.test-metrics.outputs.COVERAGE }}%",
                    "short": true
                  },
                  {
                    "title": "âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ",
                    "value": "å®Ÿè¡Œ: ${{ steps.test-metrics.outputs.TEST_TOTAL }} | å¤±æ•—: ${{ steps.test-metrics.outputs.TEST_FAILURES }} | ã‚¨ãƒ©ãƒ¼: ${{ steps.test-metrics.outputs.TEST_ERRORS }}",
                    "short": false
                  },
                  {
                    "title": "ğŸ“ ä»Šæ—¥ã®ã‚³ãƒŸãƒƒãƒˆ",
                    "value": "${{ steps.git-metrics.outputs.COMMITS_TODAY }}ä»¶",
                    "short": true
                  },
                  {
                    "title": "ğŸŒ¿ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ–ãƒ©ãƒ³ãƒ",
                    "value": "${{ steps.git-metrics.outputs.BRANCH_COUNT }}å€‹",
                    "short": true
                  },
                  {
                    "title": "ğŸ“ˆ é€±é–“å¤‰æ›´çµ±è¨ˆ",
                    "value": "è¿½åŠ : ${{ steps.git-metrics.outputs.LINES_ADDED }}è¡Œ | å‰Šé™¤: ${{ steps.git-metrics.outputs.LINES_DELETED }}è¡Œ | ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.git-metrics.outputs.FILES_CHANGED }}å€‹",
                    "short": false
                  }
                ],
                "footer": "Rush Hour Game CI/CD",
                "ts": ${{ github.event.head_commit.timestamp && fromJSON(github.event.head_commit.timestamp) || github.run_number }}
              }]
            }
